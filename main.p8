pico-8 cartridge // http://www.pico-8.com
version 39
__lua__
-- main
#include player.lua
#include entity.lua
#include fleas.lua

_elapsed_years = 0
_map_y_offset = 12
_baddie_cycle_time = 1
_baddie_swimlanes = {
  48,
  64,
  72,
  80,
}
_sword_cycle_time = 0.95
_year_cycle_time = 5
_debug = false
_timers = {
  last_sword = 0,
  last_baddie = 0,
  last_global = 0,
  last_year = 0,
}

_particles = flsrc(0, 0, 0.05, {5,6})
function _init()
  _timers.last_sword = 0
  _timers.last_baddie = 0
  _timers.last_global = 0
  _timers.last_year = 0
  _elapsed_years = 0
end

function game_draw()
  cls()
  map(0,0,0,_map_y_offset,16,16)
  player:draw(time() - _timers.last_sword)
  sword:draw()
  ent_m:draw()
  -- coffee sign
  palt(15, true)
  if _elapsed_years < 10 then
    spr(148,32,12)
  else
    spr(149,32,12)
  end
  pal()

  _particles.draw()

  for i=5,10 do
    if _elapsed_years > 1 and mget(i,1) != 145 and mget(i,1) != 146 and _elapsed_years \ 2 < 8 then
      mset(i,1,80 + _elapsed_years \ 2)
    end
  end
  if _debug then
    print("t.sword: ".._timers.last_sword,0,0,7)
    print("t.bad: ".._timers.last_baddie,0,8,7)
    print("#em.ents: "..#ent_m.ents,0,16,7)

    print("health: "..player.health, 84,0,3)
    print("ittl: "..player.ittl, 84,8,3)
    print("sttl: "..sword.ttl,84,16,3)
  else
    -- print menu
    spr(136,1,1,2,2)
    -- spr(148,8,0)
    print(_elapsed_years < 10 and "0".._elapsed_years or _elapsed_years,8,4,0)
    print("health: "..player.health, 32,4,7)
  end
end

function game_update()
  -- For sword
  local tt = time()
  local dt_sword = tt - _timers.last_sword
  if player.health == 0 and mget(7,1) != 146 then
    mset(7, 1, 146)
  end

  local dt_year = tt - _timers.last_year
  if dt_year >= _year_cycle_time then
    _timers.last_year = tt
    _elapsed_years += 1
  end

  if player.health == 0 and mget(player.x \ 8, (player.y - _map_y_offset) \ 8) == 146 then
    __draw = victory_draw
    __update = victory_update
  end

  if dt_sword >= _sword_cycle_time and player.health > 0 then
    -- do sword thing, and reset
    _timers.last_sword = tt
    sword:fire()
  end

  local dt_baddie = tt - _timers.last_baddie 
  if dt_baddie >= _baddie_cycle_time and #ent_m.ents < 3 then
    local rx = rnd(2) > 1
    local x = rx and 0 or 128
    local vx = rx and 1 or -1
    local ry = flr(rnd(3)) + 1
    ent_m:add(1,x,_baddie_swimlanes[ry],vx,0)
    _timers.last_baddie = tt
  end
  
  player:update(tt - _timers.last_global)
  sword:update(time() - _timers.last_global, player.x, player.y)
  ent_m:update(time() - _timers.last_global)
  _particles.update()

  foreach(ent_m.ents, function(e)
      if abs(distsq(player.x, player.y, e.x, e.y)) <= (player.collr + e.collr)^2 then
        player:handle_collision(e.x,e.y)
      end

      if e.state == "live" and sword.ttl > 0 and distsq(sword.x, sword.y, e.x, e.y) <= (sword.collr + e.collr)^2 then
        -- printh("collision! "..time())
        ent_m:handle_collision(e)
      end
    end)
  _timers.last_global = tt
end

__draw = game_draw
__update = game_update

function _draw()
  __draw()
end

function victory_draw()
  palt(0, false)
  rect(15,39,113,97,4)
  rectfill(16,40,112,96,0)
  pal()
  print("after ".._elapsed_years.." years, you took",20,44,4)
  print("after ".._elapsed_years.." years, you took",19,44,9)
  print("over the coffee shop",20,52,4)
  print("over the coffee shop",19,52,9)
  palt(15,true)
  spr(5,46,72,1,1,true,false)
  spr(150,66,72)
  spr(151,66,64)
  spr(138,56,72)
  pal()
end

function victory_update()
  -- stop()
end

function defeat_draw()
  cls()
  print("defeat",64,64,8)
end

function defeat_update()
  -- stop()
end

function _update60()
  __update()
end

function distsq(x1, y1, x2, y2)
  return (x2-x1)^2 + (y2-y1)^2
end

function vtoward(x1,y1,x2,y2)
  local vx,vy = x1-x2,y1-y2
  local l = sqrt(vx^2+vy^2)
  vx,vy = vx/l,vy/l
  return {x=vx,y=vy}
end
__gfx__
00000000f00ff00ff0009990fff0f000ffffffffff000ffff055550ff055550ff055550ff055550ff055550ff055550f00000000000000000000000000000000
0000000009e00e9009670e90ff090660f0ffff0ff0ccc0ff06565650065656500656565006565650065656500656565000000000000000000000000000000000
0070070009e99e90f0607e90f0f0669009000090f01c1c0f06565650065656500656565006565650065656500656565000000000000000000000000000000000
0007700007799770f0669990090660790666666000cccc0005555550055555500555555005555550055555500555555000000000000000000000000000000000
0007700007866870f0669990f06697e007066070cc3333cccc3333cccc5665cccc5665cccc5665cc555665cc5556655500000000000000000000000000000000
0070070006666660f0607e900660790f9079970900333300f033330f006665000066650000666500606665006066650600000000000000000000000000000000
000000000900009009670e900997e0ff9ee99ee9f099990ff099990ff055550ff055550ff055550f0055550f0055550000000000000000000000000000000000
00000000f0ffff0ff000999000090fff000000000cc00cc00cc00cc00cc00cc006500cc066500566665005660650056000000000000000000000000000000000
050ffffffffffffffff060ff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
5650fffffffffff0ffff060f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05650ffff0000006fff0566000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
f05650f005555556ff05650600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ff05650656666666f05650f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
fff056600555555605650fff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ffff060ff00000065650ffff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
fff060fffffffff0050fffff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb3bbbbbbbbbbbbbbb3bb444444440000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbabbbbbbbbbbbbbbbb3bbbbbbbbb3bbbbbbbbbbbbbbb33b646464640000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbba9abbbbbbbbbbbbbb3bbbbbbbbbbb3bbbbbbbbbbbbbbbbb666666660000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbabbbbbbbbbbbbbbb3bb3bbbbbbbb3bbbbbbbbbbbbbbbbbbbbbbbbb0000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbb3bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb0000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbebbbbbbb3bbb3bbbbbbbb3bbbbbbbbbbbbbbbbbbbbb0000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbe9ebbbbbbbbbb33bbbbbb3b3bbbbbbbbbbbbbbbbbbbb0000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbebbbbbbbbbbbbb3bbbbbbbbbbbbbbbbbbbbbbbbbbbb0000000000000000000000000000000000000000000000000000000000000000
77777777777777777777777777777777777777773777737737377337373373370000000000000000000000000000000000000000000000000000000000000000
77777777777777777777777737777377377773773777737737377337373733370000000000000000000000000000000000000000000000000000000000000000
77777777777777777777737773777377737773777377737774777477747774770000000000000000000000000000000000000000000000000000000000000000
77777777777777777777377737773777377737773777477747774347437743470000000000000000000000000000000000000000000000000000000000000000
77777777777737773777377737773777377737774777477747774347437743470000000000000000000000000000000000000000000000000000000000000000
77777377737773777377737773777377747774777477747774777477747734770000000000000000000000000000000000000000000000000000000000000000
37373737373737373737373737373737473737474747474747474747434743470000000000000000000000000000000000000000000000000000000000000000
66666666666666666666666666666666666666666666666666666666666666660000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
49945499454994549945499454994549945499454994549900000000ffffffff8686868686868686000000000000066000000000000000000000000000000000
49945499454994549945499454994549945499454994549900000000ff0000ff8888888888888888066066000000600600000000000000000000000000000000
74477744777447774477744777447774477744777447774400000000f055550f7777777777777775688688600006000600000000000000000000000000000000
77777777777777777777777777777777777777777777777700000000065656507777777777777775688888600000000600000000000000000000000000000000
77777777777777777777777777777777777777777777777700000000065656507777777777777775688888600000000000000000000000000000000000000000
77777777777777777777777777777777777777777777777700000000055555507777777777777775068886000000000000000000000000000000000000000000
77777777777777777777777777777777777777777777777700000000f055550f7777777777777775006860000000000000000000000000000000000000000000
77777777777777777777777777777777777777777777777700000000ff0000ff7777777777777775000600000000000000000000000000000000000000000000
77777777549494445940000088888888ff65656fff65353f06060600000000007777777777777775000000000000000000000000000000000000000000000000
77777777549494445940000088005568f6555656f653565307777700000000007777777777777775000000000000000000000000000000000000000000000000
77777777449494a449a0000080855658556565655535653574444470000000005555555555555550000000000000000000000000000000000000000000000000
777777774494944a4940000080586558557444755334443507444707000000000000000000000000000000000000000000000000000000000000000000000000
777777774494944a4940000085568508557777573573735707777707060060600000000000000000000000000000000000000000000000000000000000000000
77777777449494a449a0000086655808557777575577375307777707600060060000000000000000000000000000000000000000000000000000000000000000
77777777549494445940000086650088f5777775f337373507777770060600600000000000000000000000000000000000000000000000000000000000000000
66666666549494445940000088888888ff555555ff53535507777700600060600000000000000000000000000000000000000000000000000000000000000000
__gff__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010101010101010100000000000000000100000000000000000000000000000000000000000000000000000000000000
0101010101010000000000000000000001010200010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
4140404040808182838485404040404040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4046404040909091909090404040404040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4040404440474747474747404440404243400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4440404041404040404040404041404040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4040434042404540404140464043404540400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4040404040404043404040404040404043400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4041454044404045404041454044404042400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4043404041404040444040404540404240440000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4140404040404040404140404040404040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4440404045404042444040404540404240440000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4041404040404040404140404040404040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4042404540404140404240454040414046400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4040404043404040404040404340404040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4044404045404041404440404540404145400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4041404040404043404140404040404340400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4040404040404140404040404040414040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4040404040404046404040404040404640400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
